<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Hand-Tracked Rep Counter + Alarm (Fist Reset)</title>
<style>
  :root{
    --glass: rgba(255,255,255,0.18);
    --glass-stroke: rgba(255,255,255,0.45);
    --ink: #0f0f14;
    --ink-dim: #3a3a44;
    --accent: #0a84ff;
    --ok: #30d158;
    --warn: #ff9f0a;
    --pulse: rgba(10,132,255,0.28);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:-apple-system,system-ui,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Arial;background:radial-gradient(1200px 800px at 20% 20%,#c7e1ff 0%,#eaf1ff 45%,#f7f9ff 100%);color:var(--ink)}
  .wrap{position:relative;height:100%;display:flex;align-items:center;justify-content:center;padding:clamp(12px,4vw,32px)}
  /* hidden but active camera preview */
  video#video{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
  .card{position:relative;width:min(720px,92vw);padding:clamp(18px,4vw,32px);border-radius:28px;background:var(--glass);
    backdrop-filter:blur(18px) saturate(120%);-webkit-backdrop-filter:blur(18px) saturate(120%);
    border:1px solid var(--glass-stroke);box-shadow:0 10px 30px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(255,255,255,.15);
    display:flex;flex-direction:column;align-items:center;gap:12px}
  .glow{position:absolute;inset:-4px;background:
    radial-gradient(650px 240px at 15% 0%, rgba(10,132,255,0.14), transparent 60%),
    radial-gradient(520px 240px at 85% 100%, rgba(48,209,88,0.14), transparent 60%);
    border-radius:inherit;filter:blur(20px);pointer-events:none}
  .card.pulse{animation:pulse 0.9s ease-out 2}
  @keyframes pulse{0%{box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 0 var(--pulse)}70%{box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 24px transparent}100%{box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 0 transparent}}
  .title{font-weight:600;letter-spacing:.2px;color:var(--ink-dim);display:flex;align-items:center;gap:10px}
  .dot{width:10px;height:10px;border-radius:50%;box-shadow:0 0 16px currentColor,0 0 32px currentColor}
  .time{font-variant-numeric:tabular-nums;font-weight:700;font-size:clamp(40px,10vw,84px);line-height:1.05;letter-spacing:1px;
    padding:8px 14px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.45),rgba(255,255,255,.18));
    border:1px solid rgba(255,255,255,.5);text-shadow:0 1px 0 rgba(255,255,255,.8);
    box-shadow:inset 0 8px 24px rgba(255,255,255,.35), inset 0 -8px 20px rgba(0,0,0,.04)}
  .status{font-size:clamp(14px,2.8vw,18px);color:var(--ink-dim);padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.22))}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  .rep{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,.22));font-weight:600}
  .rep .num{font-variant-numeric:tabular-nums;font-size:22px}
  .legend{margin-top:6px;display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr;width:100%}
  .pill{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,.22));font-size:14px;color:var(--ink-dim)}
  .pill b{color:var(--ink);font-weight:600}
  .alarm{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
  .alInput{width:4.8em;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.35));font-size:16px;text-align:center}
  .btn{padding:10px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.7);background:linear-gradient(180deg,#fff,rgba(255,255,255,.6));
    font-weight:600;cursor:pointer}
  .ghost{background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.2))}
  .foot{position:fixed;bottom:8px;right:12px;opacity:.6;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <video id="video" playsinline autoplay muted></video>

  <div class="card" id="card">
    <div class="glow"></div>
    <div class="title">
      <span class="dot" id="stateDot" style="color:var(--ok)"></span>
      <span>Workout Stopwatch</span>
    </div>

    <div class="time" id="timeDisplay">00:00.00</div>
    <div class="status" id="statusText">Running</div>

    <div class="row">
      <div class="rep">Reps: <span class="num" id="repNum">0</span></div>
      <div class="alarm">
        <input id="alarmMin" class="alInput" inputmode="numeric" pattern="[0-9]*" value="00" aria-label="Alarm minutes">
        <span>:</span>
        <input id="alarmSec" class="alInput" inputmode="numeric" pattern="[0-9]*" value="30" aria-label="Alarm seconds">
        <button class="btn" id="setAlarmBtn">Set Alarm</button>
        <span id="alarmLabel" style="color:var(--ink-dim)"></span>
        <button class="btn ghost" id="soundBtn" title="Enable sound if needed">Enable Sound</button>
      </div>
    </div>

    <div class="legend" aria-hidden="true">
      <div class="pill"><b>‚úåÔ∏è Pause</b> Peace sign</div>
      <div class="pill"><b>üñê Pinky</b> Start / Resume</div>
      <div class="pill"><b>‚úä Reset</b> Fist (resets to 00:00 paused)</div>
      <div class="pill"><b>ü§è +1 Rep</b> Pinch (thumb+index)</div>
    </div>
  </div>

  <div class="foot">Gestures: ‚úåÔ∏è pause ‚Ä¢ pinky start ‚Ä¢ ‚úä reset (paused) ‚Ä¢ ü§è +1 rep</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script>
(async function(){
  const video = document.getElementById('video');
  const timeDisplay = document.getElementById('timeDisplay');
  const statusText = document.getElementById('statusText');
  const stateDot = document.getElementById('stateDot');
  const repNum = document.getElementById('repNum');
  const alarmMin = document.getElementById('alarmMin');
  const alarmSec = document.getElementById('alarmSec');
  const setAlarmBtn = document.getElementById('setAlarmBtn');
  const alarmLabel = document.getElementById('alarmLabel');
  const soundBtn = document.getElementById('soundBtn');
  const card = document.getElementById('card');

  let running = true;
  let startTime = performance.now();
  let elapsedBeforePause = 0;
  let reps = 0;

  let alarmMs = 30_000;
  let alarmArmed = true;
  let alarmFired = false;

  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === 'suspended') audioCtx.resume();
  }
  function beepPattern(){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    [0,0.25,0.5].forEach((offset)=>{
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0, t0+offset);
      gain.gain.linearRampToValueAtTime(0.6, t0+offset+0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, t0+offset+0.18);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t0+offset);
      osc.stop(t0+offset+0.2);
    });
    if(navigator.vibrate) navigator.vibrate([120,80,120]);
  }
  window.addEventListener('pointerdown', ensureAudio, {once:false});
  soundBtn.addEventListener('click', ()=>{ ensureAudio(); alert('Sound is enabled.'); });

  function format(ms){
    const total = Math.max(0, Math.floor(ms));
    const mm = Math.floor(total/60000);
    const ss = Math.floor((total%60000)/1000);
    const cs = Math.floor((total%1000)/10);
    const pad2 = n => n.toString().padStart(2,'0');
    return `${pad2(mm)}:${pad2(ss)}.${pad2(cs)}`;
  }

  function setRunning(v){
    running = v;
    statusText.textContent = v ? 'Running' : 'Paused';
    stateDot.style.color = v ? 'var(--ok)' : 'var(--warn)';
  }
  function startTimer(){
    if(!running){
      setRunning(true);
      startTime = performance.now();
    }
  }
  function pauseTimer(){
    if(running){
      setRunning(false);
      elapsedBeforePause += performance.now() - startTime;
    }
  }
  function resetAndPause(){
    // Reset time + reps, leave PAUSED at zero.
    elapsedBeforePause = 0;
    startTime = performance.now();
    reps = 0; repNum.textContent = reps;
    alarmFired = false;
    setRunning(false); // paused at 0
    // Immediately update display to 00:00.00
    timeDisplay.textContent = format(0);
  }

  function updateAlarmLabel(){
    const mm = Math.max(0, parseInt(alarmMin.value||'0',10))||0;
    const ss = Math.max(0, Math.min(59, parseInt(alarmSec.value||'0',10)))||0;
    alarmMin.value = String(mm).padStart(2,'0');
    alarmSec.value = String(ss).padStart(2,'0');
    alarmMs = (mm*60 + ss) * 1000;
    alarmArmed = alarmMs > 0;
    alarmLabel.textContent = alarmArmed ? `Alarm set: ${alarmMin.value}:${alarmSec.value}` : 'No alarm';
  }
  setAlarmBtn.addEventListener('click', ()=>{
    updateAlarmLabel();
    ensureAudio();
    card.classList.remove('pulse');
  });
  updateAlarmLabel();

  function tick(){
    let shown = elapsedBeforePause;
    if(running){
      shown += performance.now() - startTime;
    }
    timeDisplay.textContent = format(shown);

    if(alarmArmed && !alarmFired && shown >= alarmMs){
      alarmFired = true;
      ensureAudio();
      beepPattern();
      card.classList.add('pulse');
    }
    requestAnimationFrame(tick);
  }
  tick();

  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    video.srcObject = stream;
  }catch(e){
    alert('Camera access is required for hand tracking. Please allow camera permission.');
    console.error(e);
  }

  const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
  hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

  let lastGesture = 'none';
  let stableCount = 0;
  const STABLE_FRAMES = 6;

  let pinchDown = false;
  const PINCH_ON = 0.045;
  const PINCH_OFF = 0.065;

  function onResults(results){
    if(!results.multiHandLandmarks || results.multiHandLandmarks.length === 0){
      stableCount = 0; lastGesture = 'none';
      pinchDown = false;
      return;
    }
    const lm = results.multiHandLandmarks[0];
    const label = (results.multiHandedness && results.multiHandedness[0]) ? results.multiHandedness[0].label : 'Right';

    const TH = { ip:3, tip:4 };
    const IN = { pip:6, tip:8 };
    const MI = { pip:10, tip:12 };
    const RI = { pip:14, tip:16 };
    const PI = { pip:18, tip:20 };

    const fingerUp = {
      index: lm[IN.tip].y < lm[IN.pip].y,
      middle: lm[MI.tip].y < lm[MI.pip].y,
      ring: lm[RI.tip].y < lm[RI.pip].y,
      pinky: lm[PI.tip].y < lm[PI.pip].y,
      thumb: (label === 'Right') ? (lm[TH.tip].x < lm[TH.ip].x) : (lm[TH.tip].x > lm[TH.ip].x)
    };

    const isPeace = fingerUp.index && fingerUp.middle && !fingerUp.ring && !fingerUp.pinky;
    const isPinkyOnly = fingerUp.pinky && !fingerUp.index && !fingerUp.middle && !fingerUp.ring;
    const isFist = !fingerUp.index && !fingerUp.middle && !fingerUp.ring && !fingerUp.pinky && !fingerUp.thumb;

    let current = 'none';
    if(isPeace) current = 'pause';
    else if(isPinkyOnly) current = 'start';
    else if(isFist) current = 'reset';

    if(current === lastGesture){
      if(current !== 'none'){
        stableCount++;
        if(stableCount === STABLE_FRAMES){
          if(current === 'pause') pauseTimer();
          if(current === 'start') startTimer();
          if(current === 'reset') resetAndPause();
        }
      }
    } else {
      lastGesture = current;
      stableCount = (current === 'none') ? 0 : 1;
    }

    const dx = lm[4].x - lm[8].x;
    const dy = lm[4].y - lm[8].y;
    const dz = lm[4].z - lm[8].z;
    const dist = Math.hypot(dx, dy, dz*0.5);

    if(!pinchDown && dist < PINCH_ON){
      pinchDown = true;
      reps += 1;
      repNum.textContent = reps;
      card.classList.add('pulse');
      setTimeout(()=>card.classList.remove('pulse'), 400);
    } else if(pinchDown && dist > PINCH_OFF){
      pinchDown = false;
    }
  }

  const camera = new Camera(video, {
    onFrame: async () => { await hands.send({ image: video }); },
    width: 360, height: 480
  });
  camera.start();
  hands.onResults(onResults);
})();
</script>
</body>
</html>
