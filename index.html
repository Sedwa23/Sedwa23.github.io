<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Workout Stopwatch (Three = Pause)</title>
<style>
  :root{
    --glass: rgba(255,255,255,0.18);
    --glass-stroke: rgba(255,255,255,0.45);
    --ink: #0f0f14;
    --ink-dim: #3a3a44;
    --ok: #30d158;
    --warn: #ff9f0a;
    --pulse: rgba(10,132,255,0.28);
    --set: #bf5af2;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:-apple-system,system-ui,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Arial;background:radial-gradient(1200px 800px at 20% 20%,#c7e1ff 0%,#eaf1ff 45%,#f7f9ff 100%);color:var(--ink)}
  .wrap{position:relative;height:100%;display:flex;align-items:center;justify-content:center;padding:clamp(12px,4vw,32px)}
  /* Hidden but active camera feed */
  video#video{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
  .card{position:relative;width:min(720px,92vw);padding:clamp(18px,4vw,32px);border-radius:28px;background:var(--glass);
    backdrop-filter:blur(18px) saturate(120%);-webkit-backdrop-filter:blur(18px) saturate(120%);
    border:1px solid var(--glass-stroke);box-shadow:0 10px 30px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(255,255,255,.15);
    display:flex;flex-direction:column;align-items:center;gap:12px}
  .glow{position:absolute;inset:-4px;background:
    radial-gradient(650px 240px at 15% 0%, rgba(10,132,255,0.14), transparent 60%),
    radial-gradient(520px 240px at 85% 100%, rgba(48,209,88,0.14), transparent 60%);
    border-radius:inherit;filter:blur(20px);pointer-events:none}
  .card.pulse{animation:pulse 0.9s ease-out 2}
  @keyframes pulse{0%{box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 0 var(--pulse)}70%{box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 24px transparent}100%{box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 0 transparent}}
  .title{font-weight:600;letter-spacing:.2px;color:var(--ink-dim);display:flex;align-items:center;gap:10px}
  .dot{width:10px;height:10px;border-radius:50%;box-shadow:0 0 16px currentColor,0 0 32px currentColor}
  .time{font-variant-numeric:tabular-nums;font-weight:700;font-size:clamp(40px,10vw,84px);line-height:1.05;letter-spacing:1px;
    padding:8px 14px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.45),rgba(255,255,255,.18));
    border:1px solid rgba(255,255,255,.5);text-shadow:0 1px 0 rgba(255,255,255,.8);
    box-shadow:inset 0 8px 24px rgba(255,255,255,.35), inset 0 -8px 20px rgba(0,0,0,.04)}
  .status{font-size:clamp(14px,2.8vw,18px);color:var(--ink-dim);padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.22))}
  .status.set{color:#fff;background:linear-gradient(180deg,rgba(191,90,242,.9),rgba(191,90,242,.45));border-color:rgba(191,90,242,.75)}
  details.controls{width:100%;margin-top:6px}
  details.controls>summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
    padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.35));user-select:none}
  details.controls[open]>summary{background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.55))}
  .legend{margin-top:8px;display:grid;gap:8px;grid-template-columns:1fr 1fr;width:100%}
  .pill{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.55);
    background:linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,.22));font-size:14px;color:var(--ink-dim)}
  .pill b{color:var(--ink);font-weight:600}
  .foot{position:fixed;bottom:8px;right:12px;opacity:.6;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <video id="video" playsinline autoplay muted></video>

  <div class="card" id="card">
    <div class="glow"></div>
    <div class="title">
      <span class="dot" id="stateDot" style="color:var(--ok)"></span>
      <span>Workout Stopwatch</span>
    </div>

    <div class="time" id="timeDisplay">00:00.00</div>
    <div class="status" id="statusText">Running</div>

    <div class="status" id="alarmStatus" style="min-width:10ch;text-align:center;">Alarm: 00:30</div>

    <details class="controls">
      <summary>Controls</summary>
      <div class="legend" aria-hidden="true">
        <div class="pill"><b>3Ô∏è‚É£ Pause</b> Hold up three (middle+ring+pinky up)</div>
        <div class="pill"><b>üñê Pinky</b> Start / Resume</div>
        <div class="pill"><b>‚úä Reset</b> Fist (resets to 00:00 paused)</div>
        <div class="pill"><b>ü§ô Set Timer</b> Touch pinky+thumb to enter/exit</div>
        <div class="pill"><b>‚ûï +10s</b> (Set Mode) Pinch index+thumb</div>
        <div class="pill"><b>‚ûñ -10s</b> (Set Mode) Touch ring+thumb</div>
      </div>
    </details>
  </div>

  <div class="foot">Tap page once to enable sound ‚Ä¢ Allow camera</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script>
(async function(){
  const video = document.getElementById('video');
  const timeDisplay = document.getElementById('timeDisplay');
  const statusText = document.getElementById('statusText');
  const stateDot = document.getElementById('stateDot');
  const alarmStatus = document.getElementById('alarmStatus');
  const card = document.getElementById('card');

  // Stopwatch state
  let running = true;
  let startTime = performance.now();
  let elapsedBeforePause = 0;

  // Alarm state
  let alarmMs = 30_000; // 00:30 default
  let alarmArmed = true;
  let alarmFired = false;
  const MAX_ALARM_MS = 99*60*1000 + 59*1000;

  // Timer Set Mode
  let settingMode = false;

  // Audio
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === 'suspended') audioCtx.resume();
  }
  window.addEventListener('pointerdown', ensureAudio, {once:false});
  function beepPattern(){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    [0,0.25,0.5].forEach((offset)=>{
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0, t0+offset);
      gain.gain.linearRampToValueAtTime(0.6, t0+offset+0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, t0+offset+0.18);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t0+offset);
      osc.stop(t0+offset+0.2);
    });
    if(navigator.vibrate) navigator.vibrate([120,80,120]);
  }

  function format(ms){
    const total = Math.max(0, Math.floor(ms));
    const mm = Math.floor(total/60000);
    const ss = Math.floor((total%60000)/1000);
    const cs = Math.floor((total%1000)/10);
    const pad2 = n => n.toString().padStart(2,'0');
    return `${pad2(mm)}:${pad2(ss)}.${pad2(cs)}`;
  }
  function formatMMSS(ms){
    const total = Math.max(0, Math.floor(ms/1000));
    const mm = Math.floor(total/60);
    const ss = total%60;
    const pad2 = n => n.toString().padStart(2,'0');
    return `${pad2(mm)}:${pad2(ss)}`;
  }

  function setRunning(v){
    running = v;
    statusText.textContent = v ? 'Running' : 'Paused';
    stateDot.style.color = v ? 'var(--ok)' : 'var(--warn)';
  }
  function startTimer(){
    if(!running){
      setRunning(true);
      startTime = performance.now();
    }
  }
  function pauseTimer(){
    if(running){
      setRunning(false);
      elapsedBeforePause += performance.now() - startTime;
    }
  }
  function resetAndPause(){
    elapsedBeforePause = 0;
    startTime = performance.now();
    alarmFired = false;
    setRunning(false);
    timeDisplay.textContent = format(0);
  }

  function updateAlarmStatus(){
    alarmStatus.textContent = `Alarm: ${formatMMSS(alarmMs)}`;
  }
  updateAlarmStatus();

  function pulse(){ card.classList.add('pulse'); setTimeout(()=>card.classList.remove('pulse'), 450); }

  // Animation loop
  function tick(){
    let shown = elapsedBeforePause;
    if(running){
      shown += performance.now() - startTime;
    }
    timeDisplay.textContent = format(shown);

    if(alarmArmed && !alarmFired && shown >= alarmMs){
      alarmFired = true;
      ensureAudio();
      beepPattern();
      pulse();
    }
    requestAnimationFrame(tick);
  }
  tick();

  // Camera (front-facing; element hidden)
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    video.srcObject = stream;
  }catch(e){
    alert('Camera access is required for hand tracking. Please allow camera permission.\nIf you opened this from Files, try serving over HTTPS or Add to Home Screen.');
    console.error(e);
  }

  // MediaPipe Hands
  const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
  hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

  // Debounce / thresholds
  let lastGesture = 'none';
  let stableCount = 0;
  const STABLE_FRAMES = 6;

  let pinchDown = false;       // thumb-index pinch (for +10s in set mode)
  const PINCH_ON = 0.045;
  const PINCH_OFF = 0.065;

  let setTouchDown = false;    // thumb-pinky (toggle set mode)
  const SET_ON = 0.06;
  const SET_OFF = 0.085;

  let ringTouchDown = false;   // thumb-ring (-10s)
  const RING_ON = 0.06;
  const RING_OFF = 0.085;

  hands.onResults(onResults);

  function onResults(results){
    const noHand = !results.multiHandLandmarks || results.multiHandLandmarks.length === 0;
    if(noHand){
      stableCount = 0; lastGesture = 'none';
      pinchDown = false; setTouchDown = false; ringTouchDown = false;
      return;
    }
    const lm = results.multiHandLandmarks[0];
    const label = (results.multiHandedness && results.multiHandedness[0]) ? results.multiHandedness[0].label : 'Right';

    const TH = { ip:3, tip:4 };
    const IN = { pip:6, tip:8 };
    const MI = { pip:10, tip:12 };
    const RI = { pip:14, tip:16 };
    const PI = { pip:18, tip:20 };

    const fingerUp = {
      index: lm[IN.tip].y < lm[IN.pip].y,
      middle: lm[MI.tip].y < lm[MI.pip].y,
      ring: lm[RI.tip].y < lm[RI.pip].y,
      pinky: lm[PI.tip].y < lm[PI.pip].y,
      // For pause = three, we require thumb down, so detect thumb like before:
      thumb: (label === 'Right') ? (lm[TH.tip].x < lm[TH.ip].x) : (lm[TH.tip].x > lm[TH.ip].x)
    };

    // New pause gesture: "three" = middle + ring + pinky up, index & thumb down
    const isThree = !fingerUp.index && fingerUp.middle && fingerUp.ring && fingerUp.pinky && !fingerUp.thumb;
    const isPinkyOnly = fingerUp.pinky && !fingerUp.index && !fingerUp.middle && !fingerUp.ring; // start/resume
    const isFist = !fingerUp.index && !fingerUp.middle && !fingerUp.ring && !fingerUp.pinky && !fingerUp.thumb; // reset

    let current = 'none';
    if(isThree) current = 'pause';
    else if(isPinkyOnly) current = 'start';
    else if(isFist) current = 'reset';

    if(current === lastGesture){
      if(current !== 'none'){
        stableCount++;
        if(stableCount === STABLE_FRAMES){
          if(current === 'pause') pauseTimer();
          if(current === 'start') startTimer();
          if(current === 'reset') resetAndPause();
        }
      }
    } else {
      lastGesture = current;
      stableCount = (current === 'none') ? 0 : 1;
    }

    // Distances for set-mode gestures
    const dx = lm[4].x - lm[8].x;
    const dy = lm[4].y - lm[8].y;
    const dz = lm[4].z - lm[8].z;
    const pinchDist = Math.hypot(dx, dy, dz*0.5);

    const sdx = lm[4].x - lm[20].x;
    const sdy = lm[4].y - lm[20].y;
    const sdz = lm[4].z - lm[20].z;
    const setDist = Math.hypot(sdx, sdy, sdz*0.5);

    const rdx = lm[4].x - lm[16].x;
    const rdy = lm[4].y - lm[16].y;
    const rdz = lm[4].z - lm[16].z;
    const ringDist = Math.hypot(rdx, rdy, rdz*0.5);

    // Toggle timer set mode
    if(!setTouchDown && setDist < SET_ON){
      setTouchDown = true;
      settingMode = !settingMode;
      if(settingMode){
        pauseTimer();
        statusText.textContent = 'Set Timer Mode';
        statusText.classList.add('set');
      } else {
        statusText.classList.remove('set');
        statusText.textContent = running ? 'Running' : 'Paused';
        alarmArmed = alarmMs > 0;
        alarmFired = false;
        pulse();
      }
    } else if(setTouchDown && setDist > SET_OFF){
      setTouchDown = false;
    }

    if(settingMode){
      // In set mode: +10s pinch, -10s ring+thumb
      if(!pinchDown && pinchDist < PINCH_ON){
        pinchDown = true;
        alarmMs = Math.min(alarmMs + 10_000, MAX_ALARM_MS);
        updateAlarmStatus();
        pulse();
      } else if(pinchDown && pinchDist > PINCH_OFF){
        pinchDown = false;
      }
      if(!ringTouchDown && ringDist < RING_ON){
        ringTouchDown = true;
        alarmMs = Math.max(0, alarmMs - 10_000);
        updateAlarmStatus();
        pulse();
      } else if(ringTouchDown && ringDist > RING_OFF){
        ringTouchDown = false;
      }
    } else {
      // Not in set mode: ignore pinch/ring-touch for time
      pinchDown = false;
      ringTouchDown = false;
    }
  }

  // Drive MediaPipe continuously
  const camera = new Camera(video, {
    onFrame: async () => { await hands.send({ image: video }); },
    width: 360, height: 480
  });
  camera.start();
})();
</script>
</body>
</html>
